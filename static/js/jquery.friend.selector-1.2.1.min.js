/*!
 * Facebook Friend Selector
 * Copyright (c) 2013 Coders' Grave - http://codersgrave.com
 * Version: 1.2.1
 * Requires:
 *   jQuery v1.6.2 or above
 *   Facebook Integration - http://developers.facebook.com/docs/reference/javascript/
 */
;(function(e,t,n,r){"use strict";var i={},s=false,o=false,u=0,a=0,f=1,l="",c,h,p,d="http://developers.facebook.com/docs/reference/javascript/",v=function(){if(FB===r){alert("Facebook integration is not defined. View "+d);return false}i=n.extend(true,{},P,i);i.onPreStart();if(i.max>0&&i.max!==null){i.showSelectedCount=true;i.showButtonSelectAll=false}y();i.onStart()},m=function(){h.fadeOut(400,function(){c.empty();h.remove();T();p.fadeOut(400,function(){p.remove()})});s=false;o=false;i.onClose()},g=function(){var e=[];n("input.fs-friends:checked").each(function(){e.push(parseInt(n(this).val().split("-")[1],10))});if(i.facebookInvite===true){var t=e.join();FB.ui({method:"apprequests",message:i.lang.facebookInviteMessage,to:t},function(t){if(t!==null){i.onSubmit(e);if(i.closeOnSubmit===true){m()}}})}else{i.onSubmit(e);if(i.closeOnSubmit===true){m()}}},y=function(){if(s===true){return}s=true;n("body").append(p=n('<div id="fs-overlay"></div>'),h=n('<div id="fs-dialog-box-wrap"></div>'));h.append('<div class="fs-dialog-box-bg" id="fs-dialog-box-bg-n"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-ne"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-e"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-se"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-s"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-sw"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-w"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-nw"></div>');h.append(c=n('<div id="fs-dialog-box-content"></div>'));var t='<div id="fs-dialog" class="fs-color-'+i.color+'">'+'<h2 id="fs-dialog-title"><span>'+i.lang.title+"</span></h2>"+'<div id="fs-filter-box">'+'<div id="fs-input-wrap">'+'<input type="text" id="fs-input-text" title="'+i.lang.searchText+'" />'+'<a href="javascript:{}" id="fs-reset">Reset</a>'+"</div>"+"</div>"+'<div id="fs-user-list">'+"<ul></ul>"+"</div>"+'<div id="fs-filters-buttons">'+'<div id="fs-filters">'+'<a href="javascript:{}" id="fs-show-selected"><span>'+i.lang.buttonShowSelected+"</span></a>"+"</div>"+'<div id="fs-dialog-buttons">'+'<a href="javascript:{}" id="fs-submit-button" class="fs-button"><span>'+i.lang.buttonSubmit+"</span></a>"+'<a href="javascript:{}" id="fs-cancel-button" class="fs-button"><span>'+i.lang.buttonCancel+"</span></a>"+"</div>"+"</div>"+"</div>";c.html(t);b();k(true);S();_();n(e).resize(function(){k(false)})},b=function(){n("#fs-user-list").append('<div id="fs-loading"></div>');if(i.addUserGroups&&!i.facebookInvite){FB.api("/","POST",{batch:[{method:"GET",relative_url:"me/friends"},{method:"GET",relative_url:"me/groups"}]},function(e){w(e)})}else{FB.api("/me/friends",function(e){w(e)})}},w=function(e){if(e.error){alert(i.lang.fbConnectError);m();return false}var t=[];if(i.addUserGroups&&!i.facebookInvite){var t=n.parseJSON(e[0].body).data;n.merge(t,n.parseJSON(e[1].body).data)}else{t=e.data}var r=i.maxFriendsCount!==null&&i.maxFriendsCount>0;if(i.showRandom===true||r===true){t=L(e.data)}for(var s=0,o=0;s<t.length;s++){if(r&&i.maxFriendsCount<=o){break}if(n.inArray(parseInt(t[s].id,10),i.getStoredFriends)>=0){E(s,t,true);o++}}for(var u=0;u<t.length;u++){if(r&&i.maxFriendsCount<=u+i.getStoredFriends.length){break}if(n.inArray(parseInt(t[u].id,10),i.excludeIds)>=0){continue}if(n.inArray(parseInt(t[u].id,10),i.getStoredFriends)<=-1){E(u,t,false)}}n("#fs-loading").remove()},E=function(e,t,r){var i=n("<li/>");var s='<a class="fs-anchor" href="javascript://">'+'<input class="fs-fullname" type="hidden" name="fullname[]" value="'+t[e].name.toLowerCase().replace(/\s/gi,"0")+'" />'+'<input class="fs-friends" type="checkbox" name="friend[]" value="fs-'+t[e].id+'" />'+'<img class="fs-thumb" src="https://graph.facebook.com/'+t[e].id+'/picture" />'+'<span class="fs-name">'+N(t[e].name,15)+"</span>"+"</a>";i.append(s);n("#fs-user-list ul").append(i);if(r){x(i)}},S=function(){h.delegate("#fs-cancel-button","click.fs",function(){m()});h.delegate("#fs-submit-button","click.fs",function(){g()});n("#fs-dialog input").focus(function(){if(n(this).val()===n(this)[0].title){n(this).val("")}}).blur(function(){if(n(this).val()===""){n(this).val(n(this)[0].title)}}).blur();n("#fs-dialog input").keyup(function(){C(n(this))});h.delegate("#fs-reset","click.fs",function(){n("#fs-input-text").val("");C(n("#fs-dialog input"));n("#fs-input-text").blur()});h.delegate("#fs-user-list li","click.fs",function(){x(n(this))});n("#fs-show-selected").click(function(){D(n(this))});n(t).keyup(function(e){if(e.which===27&&i.enableEscapeButton===true){m()}});if(i.closeOverlayClick===true){p.css({cursor:"pointer"});p.bind("click.fs",m)}},x=function(e){var t=e;if(t.hasClass("checked")){t.removeClass("checked");t.find("input.fs-friends").prop("checked",false);f--;if(f-1!==n("#fs-user-list li").length){n("#fs-select-all").text(i.lang.buttonSelectAll)}}else{var r=A();if(r===false){t.find("input.fs-friends").prop("checked",false);return false}f++;t.addClass("checked");t.find("input.fs-friends").prop("checked",true)}O()},T=function(){n("#fs-reset").undelegate("click.fs");n("#fs-user-list li").undelegate("click.fs");f=1;n("#fs-select-all").undelegate("click.fs")},N=function(e,t){var n=e.length;if(n<=t){return e}return e.substr(0,t)+"..."},C=function(e){var t=n("#fs-dialog");var r=n("#fs-user-list ul");l=n.trim(e.val());if(l===""){n.each(r.children(),function(){n(this).show()});if(t.has("#fs-summary-box").length){if(f===1){n("#fs-summary-box").remove()}else{n("#fs-result-text").remove()}}return}var s=l.toLowerCase().replace(/\s/gi,"0");var o=n("#fs-user-list .fs-fullname[value*="+s+"]");r.children().hide();n.each(o,function(){n(this).parents("li").show()});var u="";if(o.length>0&&l>""){u=i.lang.summaryBoxResult.replace("{0}",'"'+e.val()+'"');u=u.replace("{1}",o.length)}else{u=i.lang.summaryBoxNoResult.replace("{0}",'"'+e.val()+'"')}if(!t.has("#fs-summary-box").length){n("#fs-filter-box").after('<div id="fs-summary-box"><span id="fs-result-text">'+u+"</span></div>")}else if(!t.has("#fs-result-text").length){n("#fs-summary-box").prepend('<span id="fs-result-text">'+u+"</span>")}else{n("#fs-result-text").text(u)}},k=function(r){u=n(e).width();a=n(e).height();var s=n(t).height(),o=h.width(),f=h.height(),l=u/2-o/2,c=a/2-f/2;if(r===true){p.css({"background-color":i.overlayColor,opacity:i.overlayOpacity,height:s}).fadeIn("fast",function(){h.css({left:l,top:c}).fadeIn()})}else{h.stop().animate({left:l,top:c},200);p.css({height:s})}},L=function(e){for(var t,n,r=e.length;r;t=parseInt(Math.random()*r,10),n=e[--r],e[r]=e[t],e[t]=n);return e},A=function(){if(f>i.max&&i.max!==null){var e=i.lang.selectedLimitResult.replace("{0}",i.max);n(".fs-limit").html('<span class="fs-limit fs-full">'+e+"</span>");return false}},O=function(){if(f>1&&i.showSelectedCount===true){var e=i.lang.selectedCountResult.replace("{0}",f-1);if(!n("#fs-dialog").has("#fs-summary-box").length){n("#fs-filter-box").after('<div id="fs-summary-box"><span class="fs-limit fs-count">'+e+"</span></div>")}else if(!n("#fs-dialog").has(".fs-limit.fs-count").length){n("#fs-summary-box").append('<span class="fs-limit fs-count">'+e+"</span>")}else{n(".fs-limit").text(e)}}else{if(l===""){n("#fs-summary-box").remove()}else{n(".fs-limit").remove()}}},M=function(){n("#fs-user-list li").removeClass("checked");n("#fs-user-list input.fs-friends").prop("checked",false);f=1},_=function(){if(i.showButtonSelectAll===true&&i.max===null){n("#fs-show-selected").before('<a href="javascript:{}" id="fs-select-all"><span>'+i.lang.buttonSelectAll+"</span></a> - ");h.delegate("#fs-select-all","click.fs",function(){if(f-1!==n("#fs-user-list li").length){n("#fs-user-list li:hidden").show();M();n("#fs-user-list li").each(function(){x(n(this))});n("#fs-select-all").text(i.lang.buttonDeselectAll);if(o===true){o=false;n("#fs-show-selected").text(i.lang.buttonShowSelected)}}else{M();O();n("#fs-select-all").text(i.lang.buttonSelectAll)}})}},D=function(e){var t=n("#fs-user-list ul"),r=t.find("li"),s=t.find("li.checked");if(s.length!==0&&s.length!==r.length||o===true){if(o===true){e.removeClass("active").text(i.lang.buttonShowSelected);t.children().show();o=false}else{e.addClass("active").text(i.lang.buttonShowAll);t.children().hide();n.each(s,function(){n(this).show()});o=true}}},P={max:null,excludeIds:[],getStoredFriends:[],closeOverlayClick:true,enableEscapeButton:true,overlayOpacity:"0.3",overlayColor:"#000",closeOnSubmit:false,showSelectedCount:true,showButtonSelectAll:true,addUserGroups:false,color:"default",lang:{title:"Friend Selector",buttonSubmit:"Send",buttonCancel:"Cancel",buttonSelectAll:"Select All",buttonDeselectAll:"Deselect All",buttonShowSelected:"Show Selected",buttonShowAll:"Show All",summaryBoxResult:"{1} best results for {0}",summaryBoxNoResult:"No results for {0}",searchText:"Enter a friend's name",fbConnectError:"You must connect to Facebook to see this.",selectedCountResult:"You have choosen {0} people.",selectedLimitResult:"Limit is {0} people.",facebookInviteMessage:"Invite message"},maxFriendsCount:null,showRandom:false,facebookInvite:true,onPreStart:function(e){return null},onStart:function(e){return null},onClose:function(e){return null},onSubmit:function(e){return null}};n.fn.fSelector=function(e){this.unbind("click.fs");this.bind("click.fs",function(){i=e;v()});return this}})(window,document,jQuery);