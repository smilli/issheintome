/*!
 * Facebook Friend Selector
 * Copyright (c) 2013 Coders' Grave - http://codersgrave.com
 * Version: 1.2.1
 * Requires:
 *   jQuery v1.6.2 or above
 *   Facebook Integration - http://developers.facebook.com/docs/reference/javascript/
 */
;(function(r,y,h,l){var j={},d=false,o=false,I=0,u=0,H=1,b="",A,s,D,c="http://developers.facebook.com/docs/reference/javascript/",C=function(){if(FB===l){alert("Facebook integration is not defined. View "+c);return false}j=h.extend(true,{},t,j);if(j.max>0&&j.max!==null){j.showSelectedCount=true;j.showButtonSelectAll=false}w();j.onStart()},e=function(){s.fadeOut(400,function(){A.empty();s.remove();z();D.fadeOut(400,function(){D.remove()})});d=false;o=false;j.onClose()},G=function(){var J=[];h("input.fs-friends:checked").each(function(){J.push(parseInt(h(this).val().split("-")[1],10))});if(j.facebookInvite===true){var K=J.join();FB.ui({method:"apprequests",message:j.lang.facebookInviteMessage,to:K},function(L){if(L!==null){j.onSubmit(J);if(j.closeOnSubmit===true){e()}}})}else{j.onSubmit(J);if(j.closeOnSubmit===true){e()}}},w=function(){if(d===true){return}d=true;h("body").append(D=h('<div id="fs-overlay"></div>'),s=h('<div id="fs-dialog-box-wrap"></div>'));s.append('<div class="fs-dialog-box-bg" id="fs-dialog-box-bg-n"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-ne"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-e"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-se"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-s"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-sw"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-w"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-nw"></div>');s.append(A=h('<div id="fs-dialog-box-content"></div>'));var J='<div id="fs-dialog" class="fs-color-'+j.color+'"><h2 id="fs-dialog-title"><span>'+j.lang.title+'</span></h2><div id="fs-filter-box"><div id="fs-input-wrap"><input type="text" id="fs-input-text" title="'+j.lang.searchText+'" /><a href="javascript:{}" id="fs-reset">Reset</a></div></div><div id="fs-user-list"><ul></ul></div><div id="fs-filters-buttons"><div id="fs-filters"><a href="javascript:{}" id="fs-show-selected"><span>'+j.lang.buttonShowSelected+'</span></a></div><div id="fs-dialog-buttons"><a href="javascript:{}" id="fs-submit-button" class="fs-button"><span>'+j.lang.buttonSubmit+'</span></a><a href="javascript:{}" id="fs-cancel-button" class="fs-button"><span>'+j.lang.buttonCancel+"</span></a></div></div></div>";A.html(J);n();m(true);i();k();h(r).resize(function(){m(false)})},n=function(){h("#fs-user-list").append('<div id="fs-loading"></div>');if(j.addUserGroups&&!j.facebookInvite){FB.api("/","POST",{batch:[{method:"GET",relative_url:"me/friends"},{method:"GET",relative_url:"me/groups"}]},function(J){B(J)})}else{FB.api("/me/friends",function(J){B(J)})}},B=function(L){if(L.error){alert(j.lang.fbConnectError);e();return false}var K=[];if(j.addUserGroups&&!j.facebookInvite){var K=h.parseJSON(L[0].body).data;h.merge(K,h.parseJSON(L[1].body).data)}else{K=L.data}var O=j.maxFriendsCount!==null&&j.maxFriendsCount>0;if(j.showRandom===true||O===true){K=E(L.data)}for(var N=0,J=0;N<K.length;N++){if(O&&j.maxFriendsCount<=J){break}if(h.inArray(parseInt(K[N].id,10),j.getStoredFriends)>=0){F(N,K,true);J++}}for(var M=0;M<K.length;M++){if(O&&j.maxFriendsCount<=M+j.getStoredFriends.length){break}if(h.inArray(parseInt(K[M].id,10),j.excludeIds)>=0){continue}if(h.inArray(parseInt(K[M].id,10),j.getStoredFriends)<=-1){F(M,K,false)}}h("#fs-loading").remove()},F=function(K,J,N){var M=h("<li/>");var L='<a class="fs-anchor" href="javascript://"><input class="fs-fullname" type="hidden" name="fullname[]" value="'+J[K].name.toLowerCase().replace(/\s/gi,"+")+'" /><input class="fs-friends" type="checkbox" name="friend[]" value="fs-'+J[K].id+'" /><img class="fs-thumb" src="https://graph.facebook.com/'+J[K].id+'/picture" /><span class="fs-name">'+g(J[K].name,15)+"</span></a>";M.append(L);h("#fs-user-list ul").append(M);if(N){a(M)}},i=function(){s.delegate("#fs-cancel-button","click.fs",function(){e()});s.delegate("#fs-submit-button","click.fs",function(){G()});h("#fs-dialog input").focus(function(){if(h(this).val()===h(this)[0].title){h(this).val("")}}).blur(function(){if(h(this).val()===""){h(this).val(h(this)[0].title)}}).blur();h("#fs-dialog input").keyup(function(){f(h(this))});s.delegate("#fs-reset","click.fs",function(){h("#fs-input-text").val("");f(h("#fs-dialog input"));h("#fs-input-text").blur()});s.delegate("#fs-user-list li","click.fs",function(){a(h(this))});h("#fs-show-selected").click(function(){p(h(this))});h(y).keyup(function(J){if(J.which===27&&j.enableEscapeButton===true){e()}});if(j.closeOverlayClick===true){D.css({cursor:"pointer"});D.bind("click.fs",e)}},a=function(L){var K=L;if(K.hasClass("checked")){K.removeClass("checked");K.find("input.fs-friends").attr("checked",false);H--;if(H-1!==h("#fs-user-list li").length){h("#fs-select-all").text(j.lang.buttonSelectAll)}}else{var J=q();if(J===false){K.find("input.fs-friends").attr("checked",false);return false}H++;K.addClass("checked");K.find("input.fs-friends").attr("checked",true)}x()},z=function(){h("#fs-reset").undelegate("click.fs");h("#fs-user-list li").undelegate("click.fs");H=1;h("#fs-select-all").undelegate("click.fs")},g=function(L,J){var K=L.length;if(K<=J){return L}return L.substr(0,J)+"..."},f=function(L){var M=h("#fs-dialog");b=h.trim(L.val());var K=b.toLowerCase().replace(/\s/gi,"+");var N=h("#fs-user-list .fs-fullname[value*="+K+"]");var J=h("#fs-user-list ul");J.children().hide();h.each(N,function(){h(this).parents("li").show()});var O="";if(N.length>0&&b>""){O=j.lang.summaryBoxResult.replace("{0}",'"'+L.val()+'"');O=O.replace("{1}",N.length)}else{O=j.lang.summaryBoxNoResult.replace("{0}",'"'+L.val()+'"')}if(!M.has("#fs-summary-box").length){h("#fs-filter-box").after('<div id="fs-summary-box"><span id="fs-result-text">'+O+"</span></div>")}else{if(!M.has("#fs-result-text").length){h("#fs-summary-box").prepend('<span id="fs-result-text">'+O+"</span>")}else{h("#fs-result-text").text(O)}}if(b===""){if(M.has("#fs-summary-box").length){if(H===1){h("#fs-summary-box").remove()}else{h("#fs-result-text").remove()}}}},m=function(N){I=h(r).width();u=h(r).height();var M=h(y).height(),O=s.width(),K=s.height(),L=(I/2)-(O/2),J=(u/2)-(K/2);if(N===true){D.css({"background-color":j.overlayColor,opacity:j.overlayOpacity,height:M}).fadeIn("fast",function(){s.css({left:L,top:J}).fadeIn()})}else{s.stop().animate({left:L,top:J},200);D.css({height:M})}},E=function(M){for(var K,J,L=M.length;L;K=parseInt(Math.random()*L,10),J=M[--L],M[L]=M[K],M[K]=J){}return M},q=function(){if(H>j.max&&j.max!==null){var J=j.lang.selectedLimitResult.replace("{0}",j.max);h(".fs-limit").html('<span class="fs-limit fs-full">'+J+"</span>");return false}},x=function(){if(H>1&&j.showSelectedCount===true){var J=j.lang.selectedCountResult.replace("{0}",(H-1));if(!h("#fs-dialog").has("#fs-summary-box").length){h("#fs-filter-box").after('<div id="fs-summary-box"><span class="fs-limit fs-count">'+J+"</span></div>")}else{if(!h("#fs-dialog").has(".fs-limit.fs-count").length){h("#fs-summary-box").append('<span class="fs-limit fs-count">'+J+"</span>")}else{h(".fs-limit").text(J)}}}else{if(b===""){h("#fs-summary-box").remove()}else{h(".fs-limit").remove()}}},v=function(){h("#fs-user-list li").removeClass("checked");h("#fs-user-list input.fs-friends").attr("checked",false);H=1},k=function(){if(j.showButtonSelectAll===true&&j.max===null){h("#fs-show-selected").before('<a href="javascript:{}" id="fs-select-all"><span>'+j.lang.buttonSelectAll+"</span></a> - ");s.delegate("#fs-select-all","click.fs",function(){if(H-1!==h("#fs-user-list li").length){h("#fs-user-list li:hidden").show();v();h("#fs-user-list li").each(function(){a(h(this))});h("#fs-select-all").text(j.lang.buttonDeselectAll);if(o===true){o=false;h("#fs-show-selected").text(j.lang.buttonShowSelected)}}else{v();x();h("#fs-select-all").text(j.lang.buttonSelectAll)}})}},p=function(K){var J=h("#fs-user-list ul"),L=J.find("li"),M=J.find("li.checked");if(M.length!==0&&M.length!==L.length||o===true){if(o===true){K.removeClass("active").text(j.lang.buttonShowSelected);J.children().show();o=false}else{K.addClass("active").text(j.lang.buttonShowAll);J.children().hide();h.each(M,function(){h(this).show()});o=true}}},t={max:null,excludeIds:[],getStoredFriends:[],closeOverlayClick:true,enableEscapeButton:true,overlayOpacity:"0.3",overlayColor:"#000",closeOnSubmit:false,showSelectedCount:true,showButtonSelectAll:true,addUserGroups:false,color:"default",lang:{title:"Friend Selector",buttonSubmit:"Send",buttonCancel:"Cancel",buttonSelectAll:"Select All",buttonDeselectAll:"Deselect All",buttonShowSelected:"Show Selected",buttonShowAll:"Show All",summaryBoxResult:"{1} best results for {0}",summaryBoxNoResult:"No results for {0}",searchText:"Enter a friend's name",fbConnectError:"You must connect to Facebook to see this.",selectedCountResult:"You have choosen {0} people.",selectedLimitResult:"Limit is {0} people.",facebookInviteMessage:"Invite message"},maxFriendsCount:null,showRandom:false,facebookInvite:true,onStart:function(J){return null},onClose:function(J){return null},onSubmit:function(J){return null}};h.fn.fSelector=function(J){this.unbind("click.fs");this.bind("click.fs",function(){j=J;C()});return this}})(window,document,jQuery);